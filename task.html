<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ProPlanner Ultimate v2 | Organize Your Life</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary)',
                        'primary-fg': 'var(--primary-fg)',
                        bg: 'var(--bg)',
                        'bg-sec': 'var(--bg-sec)',
                        card: 'var(--card)',
                        text: 'var(--text)',
                        muted: 'var(--muted)',
                        border: 'var(--border)',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: {
                        'bounce-slight': 'bounce-slight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'slide-up-sheet': 'slide-up-sheet 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'stagger-up': 'staggerUp 0.4s ease-out forwards',
                    },
                    keyframes: {
                        'bounce-slight': {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(0.95)' },
                        },
                        'slide-up-sheet': {
                            '0%': { transform: 'translateY(100%)', opacity: 0 },
                            '100%': { transform: 'translateY(0)', opacity: 1 },
                        },
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        },
                        staggerUp: {
                            '0%': { opacity: 0, transform: 'translateY(15px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; --primary-fg: #ffffff;
            --bg: #f8fafc; --bg-sec: #f1f5f9; --card: #ffffff;
            --text: #0f172a; --muted: #64748b;
            --border: #e2e8f0;
        }
        .dark {
            --primary: #818cf8; --primary-fg: #ffffff;
            --bg: #0f172a; --bg-sec: #1e293b; --card: #1e293b;
            --text: #f8fafc; --muted: #94a3b8;
            --border: #334155;
        }
        .midnight {
            --primary: #38bdf8; --primary-fg: #0f172a;
            --bg: #020617; --bg-sec: #0f172a; --card: #0f172a;
            --text: #e2e8f0; --muted: #475569;
            --border: #1e293b;
        }

        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.4s ease, color 0.4s ease;
        }
        
        /* Smooth Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 10px; opacity: 0.2; }

        /* Glassmorphism Classes */
        .glass-header { background: rgba(var(--bg), 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .glass-nav { background: rgba(var(--card), 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }

        /* Helpers */
        .pb-safe { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
        .pt-safe { padding-top: max(1rem, env(safe-area-inset-top)); }
        
        /* Modal & Sheet Adjustments */
        .sheet-handle { width: 40px; height: 5px; background: var(--border); border-radius: 10px; margin: 0 auto 16px; }
        
        /* Task Card Checkbox Animation */
        .task-checkbox:checked + div {
            text-decoration: line-through;
            color: var(--muted);
            opacity: 0.7;
        }

        /* Toast Notifications */
        #toast-container { position: fixed; top: env(safe-area-inset-top, 20px); left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-w: 400px; }
        .toast { pointer-events: auto; padding: 14px 20px; background: var(--card); border: 1px solid var(--border); color: var(--text); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-radius: 12px; font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 12px; animation: slideDownBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes slideDownBounce { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* Line Clamp Fix */
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="h-[100dvh] w-screen flex overflow-hidden selection:bg-primary selection:text-white antialiased">

    <!-- Toast Container -->
    <div id="toast-container" class="mt-4"></div>

    <!-- Sidebar (Desktop) -->
    <aside class="hidden md:flex flex-col w-72 bg-card border-r border-border p-6 transition-colors duration-300 z-20">
        <div class="flex items-center gap-4 mb-10 pt-4">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-primary to-indigo-600 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-primary/30">P</div>
            <h1 class="text-2xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-text to-muted">ProPlanner</h1>
        </div>

        <nav class="space-y-2 flex-1">
            <button onclick="app.router('dashboard')" class="nav-item w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-semibold transition-all duration-300 hover:bg-bg-sec hover:translate-x-1" data-target="dashboard">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Dashboard
            </button>
            <button onclick="app.router('calendar')" class="nav-item w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-semibold transition-all duration-300 hover:bg-bg-sec hover:translate-x-1" data-target="calendar">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Calendar
            </button>
            <button onclick="app.router('focus')" class="nav-item w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl text-sm font-semibold transition-all duration-300 hover:bg-bg-sec hover:translate-x-1" data-target="focus">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Focus Mode
            </button>
        </nav>

        <div class="mt-auto pt-6">
            <div class="bg-bg-sec rounded-2xl p-5 mb-4 border border-border">
                <div class="flex justify-between items-end mb-3">
                    <span class="text-xs font-bold text-muted uppercase tracking-wider">Level <span id="user-level" class="text-text text-sm">1</span></span>
                    <span class="text-xs font-extrabold text-primary"><span id="user-xp">0</span> XP</span>
                </div>
                <div class="w-full bg-border rounded-full h-2.5 overflow-hidden">
                    <div id="xp-bar" class="bg-gradient-to-r from-primary to-indigo-400 h-full rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                </div>
            </div>
            <button onclick="app.ui.toggleSettings()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-muted hover:text-text hover:bg-bg-sec rounded-2xl transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                Settings & Data
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-[100dvh] relative overflow-hidden bg-bg">
        
        <!-- Header (Mobile + Search) -->
        <header class="flex justify-between items-center p-4 md:px-8 md:py-6 glass-header sticky top-0 z-10 border-b border-border/50 pt-safe">
            <div class="md:hidden flex items-center gap-3">
                 <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-primary to-indigo-600 flex items-center justify-center text-white font-bold shadow-md">P</div>
                 <h1 class="text-lg font-extrabold tracking-tight">ProPlanner</h1>
            </div>
            
            <!-- Global Search -->
            <div class="flex-1 max-w-md ml-auto relative group md:mx-0">
                <svg class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-muted group-focus-within:text-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input type="text" id="global-search" oninput="app.utils.debounceSearch(this.value)" placeholder="Search tasks..." class="w-full pl-11 pr-4 py-2.5 md:py-3 rounded-full bg-card border border-border focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm md:text-base shadow-sm">
            </div>

            <button onclick="app.ui.toggleSettings()" class="md:hidden ml-3 p-2 text-muted hover:text-primary bg-card rounded-full border border-border shadow-sm"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
        </header>

        <!-- Dynamic View Container -->
        <div id="view-container" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-32 md:pb-8"></div>

        <!-- Floating Action Button -->
        <button onclick="app.ui.openTaskModal()" class="absolute bottom-24 md:bottom-8 right-4 md:right-8 w-14 h-14 md:w-16 md:h-16 bg-gradient-to-tr from-primary to-indigo-500 text-white rounded-full shadow-xl shadow-primary/40 flex items-center justify-center hover:scale-105 hover:shadow-primary/50 active:scale-95 transition-all z-30 group">
            <svg class="w-7 h-7 group-hover:rotate-90 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
        </button>
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 w-full glass-nav border-t border-border/50 flex justify-around px-2 py-2 pb-safe z-40">
        <button onclick="app.router('dashboard')" class="nav-item flex-1 flex flex-col items-center justify-center py-2 text-muted gap-1 transition-all rounded-2xl relative" data-target="dashboard">
            <div class="nav-indicator absolute inset-0 bg-primary/10 rounded-xl scale-50 opacity-0 transition-all duration-300"></div>
            <svg class="w-6 h-6 relative z-10 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span class="text-[10px] font-bold tracking-wide relative z-10">Home</span>
        </button>
        <button onclick="app.router('calendar')" class="nav-item flex-1 flex flex-col items-center justify-center py-2 text-muted gap-1 transition-all rounded-2xl relative" data-target="calendar">
            <div class="nav-indicator absolute inset-0 bg-primary/10 rounded-xl scale-50 opacity-0 transition-all duration-300"></div>
            <svg class="w-6 h-6 relative z-10 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span class="text-[10px] font-bold tracking-wide relative z-10">Plan</span>
        </button>
        <button onclick="app.router('focus')" class="nav-item flex-1 flex flex-col items-center justify-center py-2 text-muted gap-1 transition-all rounded-2xl relative" data-target="focus">
            <div class="nav-indicator absolute inset-0 bg-primary/10 rounded-xl scale-50 opacity-0 transition-all duration-300"></div>
            <svg class="w-6 h-6 relative z-10 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-[10px] font-bold tracking-wide relative z-10">Focus</span>
        </button>
    </nav>

    <!-- Task Modal (Bottom Sheet on Mobile) -->
    <div id="task-modal" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-end md:items-center justify-center transition-opacity duration-300" onclick="if(event.target === this) app.ui.closeModals()">
        <div class="bg-card w-full md:max-w-lg rounded-t-[2rem] md:rounded-3xl p-6 md:p-8 animate-slide-up-sheet md:animate-fade-in shadow-2xl max-h-[90vh] overflow-y-auto pb-safe border border-border/50">
            <div class="sheet-handle md:hidden"></div>
            <h2 class="text-2xl font-extrabold mb-6 flex justify-between items-center text-text">
                <span id="modal-title">New Task</span>
                <button type="button" onclick="app.ui.closeModals()" class="w-8 h-8 rounded-full bg-bg-sec hover:bg-border flex items-center justify-center transition-colors text-muted hover:text-text">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </h2>
            <form id="task-form" class="space-y-5">
                <input type="hidden" id="task-id">
                
                <!-- Task Name -->
                <div>
                    <label class="block text-xs font-bold text-muted uppercase tracking-widest mb-1.5 ml-1">Task Name</label>
                    <input id="task-name" type="text" placeholder="What needs to be done?" required class="w-full p-4 rounded-2xl bg-bg border border-border focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-text font-medium placeholder:text-muted/60 shadow-sm">
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-xs font-bold text-muted uppercase tracking-widest mb-1.5 ml-1">Description <span class="text-muted/50 font-normal lowercase">(optional)</span></label>
                    <textarea id="task-desc" rows="2" placeholder="Add extra details..." class="w-full p-4 rounded-2xl bg-bg border border-border focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all resize-none text-text text-sm shadow-sm"></textarea>
                </div>

                <!-- Date & Priority -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-muted uppercase tracking-widest mb-1.5 ml-1">Deadline</label>
                        <input id="task-date" type="date" required class="w-full p-3.5 rounded-2xl bg-bg border border-border outline-none focus:ring-2 focus:ring-primary/50 text-text text-sm shadow-sm font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-muted uppercase tracking-widest mb-1.5 ml-1">Priority</label>
                        <div class="relative">
                            <select id="task-priority" class="w-full p-3.5 rounded-2xl bg-bg border border-border outline-none focus:ring-2 focus:ring-primary/50 appearance-none text-text text-sm shadow-sm font-medium">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                            <svg class="w-4 h-4 absolute right-4 top-1/2 -translate-y-1/2 text-muted pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Category & Recurrence -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-muted uppercase tracking-widest mb-1.5 ml-1">Category</label>
                        <input id="task-category" type="text" placeholder="e.g. Work" class="w-full p-3.5 rounded-2xl bg-bg border border-border outline-none focus:ring-2 focus:ring-primary/50 text-text text-sm shadow-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-muted uppercase tracking-widest mb-1.5 ml-1">Repeat</label>
                        <div class="relative">
                            <select id="task-repeat" class="w-full p-3.5 rounded-2xl bg-bg border border-border outline-none focus:ring-2 focus:ring-primary/50 appearance-none text-text text-sm shadow-sm font-medium">
                                <option value="none">None</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                            <svg class="w-4 h-4 absolute right-4 top-1/2 -translate-y-1/2 text-muted pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 pt-6 border-t border-border mt-6">
                    <button type="button" id="btn-delete" class="hidden px-5 py-3.5 text-red-500 bg-red-500/10 rounded-2xl font-bold hover:bg-red-500/20 active:scale-95 transition-all" onclick="app.tasks.delete()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                    <button type="submit" class="flex-1 py-3.5 bg-primary text-white rounded-2xl font-bold hover:bg-indigo-600 active:scale-95 shadow-lg shadow-primary/30 transition-all flex items-center justify-center gap-2 text-base">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
                        Save Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-end md:items-center justify-center transition-opacity duration-300" onclick="if(event.target === this) app.ui.closeModals()">
        <div class="bg-card w-full max-w-md rounded-t-[2rem] md:rounded-3xl p-6 md:p-8 animate-slide-up-sheet md:animate-fade-in shadow-2xl pb-safe border border-border/50">
            <div class="sheet-handle md:hidden"></div>
            <h2 class="text-2xl font-extrabold mb-8 text-text">Settings</h2>
            <div class="space-y-8">
                <div>
                    <h3 class="text-xs font-bold text-muted mb-4 uppercase tracking-widest ml-1">Appearance</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="app.ui.setTheme('light')" id="theme-btn-light" class="p-4 rounded-2xl border border-border bg-[#f8fafc] text-slate-800 font-semibold hover:border-primary transition-all flex flex-col items-center gap-2">
                            <span class="w-6 h-6 rounded-full bg-white border border-slate-200"></span>Light
                        </button>
                        <button onclick="app.ui.setTheme('dark')" id="theme-btn-dark" class="p-4 rounded-2xl border border-border bg-[#0f172a] text-white font-semibold hover:border-primary transition-all flex flex-col items-center gap-2">
                            <span class="w-6 h-6 rounded-full bg-[#1e293b] border border-slate-700"></span>Dark
                        </button>
                        <button onclick="app.ui.setTheme('midnight')" id="theme-btn-midnight" class="p-4 rounded-2xl border border-border bg-[#020617] text-blue-200 font-semibold hover:border-primary transition-all flex flex-col items-center gap-2">
                            <span class="w-6 h-6 rounded-full bg-[#0f172a] border border-slate-800"></span>Void
                        </button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-muted mb-4 uppercase tracking-widest ml-1">Data Management</h3>
                    <div class="flex flex-col gap-3">
                        <button onclick="app.data.backup()" class="flex items-center justify-center gap-3 p-4 rounded-2xl bg-bg border border-border font-semibold hover:border-primary hover:text-primary transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export Backup
                        </button>
                        <button onclick="document.getElementById('import-file').click()" class="flex items-center justify-center gap-3 p-4 rounded-2xl bg-bg border border-border font-semibold hover:border-primary hover:text-primary transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            Import Data
                        </button>
                        <button onclick="app.data.clear()" class="flex items-center justify-center gap-3 p-4 rounded-2xl bg-red-500/10 text-red-500 font-semibold hover:bg-red-500/20 transition-colors mt-2">
                            Wipe All Data
                        </button>
                        <input type="file" id="import-file" class="hidden" accept=".json" onchange="app.data.restore(this)">
                    </div>
                </div>
            </div>
            <button onclick="app.ui.closeModals()" class="w-full mt-8 py-4 rounded-2xl bg-primary text-white font-bold text-lg hover:bg-indigo-600 active:scale-95 transition-all shadow-lg shadow-primary/30">Done</button>
        </div>
    </div>

    <!-- Focus Overlay -->
    <div id="focus-overlay" class="hidden fixed inset-0 z-[60] bg-bg flex flex-col items-center justify-center p-6 text-center animate-fade-in">
        <div class="max-w-md w-full relative h-full flex flex-col justify-center">
            <button onclick="app.focus.exit()" class="absolute top-safe right-0 p-2 bg-card rounded-full shadow-sm border border-border text-muted hover:text-text active:scale-95 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            
            <div class="mb-6"><span class="px-4 py-1.5 rounded-full bg-primary/15 text-primary text-sm font-bold uppercase tracking-widest">Focus Session</span></div>
            <h2 id="focus-task-display" class="text-2xl md:text-3xl font-extrabold mb-12 text-text line-clamp-2 px-4 leading-tight">Deep Work</h2>
            
            <div class="relative w-72 h-72 mx-auto mb-16 flex items-center justify-center">
                <svg class="absolute inset-0 w-full h-full transform -rotate-90 drop-shadow-xl" viewBox="0 0 256 256">
                    <circle cx="128" cy="128" r="116" stroke="currentColor" stroke-width="8" fill="transparent" class="text-border" />
                    <!-- Circumference = 2 * PI * 116 â‰ˆ 728.8 -->
                    <circle id="timer-circle" cx="128" cy="128" r="116" stroke="currentColor" stroke-width="12" fill="transparent" stroke-dasharray="729" stroke-dashoffset="0" stroke-linecap="round" class="text-primary transition-all duration-1000 ease-linear" />
                </svg>
                <div id="timer-display" class="text-6xl font-black font-mono tracking-tighter tabular-nums text-text drop-shadow-sm">25:00</div>
            </div>

            <div class="flex justify-center gap-4 px-6">
                <button id="focus-toggle" onclick="app.focus.toggle()" class="w-full max-w-[200px] py-4 rounded-full bg-primary text-white font-bold text-lg hover:bg-indigo-600 active:scale-95 transition-all shadow-xl shadow-primary/40">Start</button>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        const app = {
            state: {
                tasks: [],
                profile: { xp: 0, level: 1, streak: 0, lastLogin: null },
                view: 'dashboard',
                calendarMode: 'monthly',
                currentDate: new Date(),
                theme: 'light',
                searchQuery: '',
                timer: { interval: null, timeLeft: 1500, totalTime: 1500, isRunning: false, activeTask: null }
            },

            init: () => {
                // Load & Parse Data
                try {
                    const saved = localStorage.getItem('proplanner_db_v2');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        app.state.tasks = parsed.tasks || [];
                        app.state.profile = parsed.profile || app.state.profile;
                        app.state.theme = parsed.theme || 'light';
                    }
                } catch(e) { console.error("Data load error", e); }
                
                // Initialize System
                app.ui.setTheme(app.state.theme);
                app.tasks.checkRecurring();
                app.gamification.checkStreak();
                
                // Route & Render
                app.router(app.state.view);
                app.ui.renderProfile();

                // Global Listener
                document.getElementById('task-form').addEventListener('submit', app.tasks.save);
                
                // Keyboard Shortcut for Search
                document.addEventListener('keydown', (e) => {
                    if((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        document.getElementById('global-search').focus();
                    }
                    if(e.key === 'Escape') app.ui.closeModals();
                });
            },

            persist: () => {
                localStorage.setItem('proplanner_db_v2', JSON.stringify({
                    tasks: app.state.tasks,
                    profile: app.state.profile,
                    theme: app.state.theme
                }));
                app.ui.renderProfile();
            },

            router: (viewName) => {
                app.state.view = viewName;
                
                // Update Nav UI
                document.querySelectorAll('.nav-item').forEach(el => {
                    const isActive = el.dataset.target === viewName;
                    el.classList.toggle('text-primary', isActive);
                    el.classList.toggle('text-muted', !isActive);
                    
                    const indicator = el.querySelector('.nav-indicator');
                    if(indicator) {
                        indicator.style.opacity = isActive ? '1' : '0';
                        indicator.style.transform = isActive ? 'scale(1)' : 'scale(0.5)';
                    }
                    
                    // Desktop sidebar
                    if(!indicator) {
                        el.classList.toggle('bg-bg-sec', isActive);
                    }
                });

                const container = document.getElementById('view-container');
                container.innerHTML = '';
                
                // Search Override
                if(app.state.searchQuery.length > 0) {
                    app.views.searchResults(container);
                    return;
                }

                switch(viewName) {
                    case 'dashboard': app.views.dashboard(container); break;
                    case 'calendar': app.views.calendar(container); break;
                    case 'focus': app.views.focus(container); break;
                }
            },

            views: {
                dashboard: (container) => {
                    const todayStr = new Date().toDateString();
                    const todayTasks = app.state.tasks.filter(t => !t.completed && new Date(t.date).toDateString() === todayStr);
                    const overdue = app.state.tasks.filter(t => !t.completed && new Date(t.date) < new Date().setHours(0,0,0,0));
                    
                    // Simple Activity Graph Logic (Last 7 days)
                    const last7Days = Array.from({length: 7}, (_, i) => {
                        const d = new Date(); d.setDate(d.getDate() - (6-i));
                        return d;
                    });
                    
                    const activityHtml = last7Days.map(day => {
                        const dateStr = day.toISOString().split('T')[0];
                        const count = app.state.tasks.filter(t => t.completed && t.completedDate === dateStr).length;
                        const height = Math.min(100, Math.max(15, count * 25)); // Cap at 100%
                        const isToday = day.toDateString() === todayStr;
                        return `<div class="flex flex-col items-center gap-1.5 group">
                            <div class="w-2.5 md:w-3.5 bg-bg rounded-full h-16 md:h-20 relative overflow-hidden border border-border/50">
                                <div class="absolute bottom-0 w-full ${isToday ? 'bg-primary' : 'bg-primary/50'} rounded-full transition-all duration-1000 ease-out" style="height: ${height}%"></div>
                            </div>
                            <span class="text-[9px] ${isToday ? 'text-primary font-bold' : 'text-muted'} uppercase">${day.toLocaleDateString('en-US',{weekday:'narrow'})}</span>
                        </div>`;
                    }).join('');

                    container.innerHTML = `
                        <div class="animate-fade-in space-y-8 max-w-5xl mx-auto">
                            <!-- Hero Section -->
                            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-end gap-6">
                                <div>
                                    <h2 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-2 text-text">Welcome back.</h2>
                                    <p class="text-muted text-sm md:text-base font-medium">You have <strong class="text-primary">${todayTasks.length}</strong> tasks pending today.</p>
                                </div>
                                <div class="flex gap-4 w-full lg:w-auto overflow-x-auto pb-2 -mb-2">
                                     <div class="bg-card px-5 py-4 rounded-3xl border border-border/50 shadow-sm flex flex-col justify-center min-w-[100px]">
                                        <div class="text-[10px] text-muted uppercase font-bold tracking-widest mb-1">Streak</div>
                                        <div class="text-2xl font-black text-orange-500 flex items-center gap-1">ðŸ”¥ ${app.state.profile.streak}</div>
                                    </div>
                                    <div class="bg-card px-5 py-4 rounded-3xl border border-border/50 shadow-sm flex gap-3 min-w-max">
                                        ${activityHtml}
                                    </div>
                                </div>
                            </div>

                            ${overdue.length ? `
                            <div class="bg-red-500/10 border border-red-500/20 p-4 md:p-5 rounded-3xl flex items-center justify-between group cursor-pointer hover:bg-red-500/15 transition-all shadow-sm active:scale-[0.98]">
                                <div class="flex items-center gap-4 text-red-600 dark:text-red-400">
                                    <div class="p-2 bg-red-500/20 rounded-xl">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                    </div>
                                    <span class="font-extrabold text-sm md:text-base">${overdue.length} Tasks Overdue</span>
                                </div>
                                <span class="text-xs font-black text-red-500 uppercase tracking-widest bg-red-500/10 px-3 py-1.5 rounded-lg hidden md:block">Review</span>
                            </div>` : ''}
                            
                            <!-- Tasks Section -->
                            <div>
                                <h3 class="font-extrabold mb-5 text-lg md:text-xl flex items-center gap-3">
                                    Today's Priority
                                    <span class="text-xs bg-primary/10 text-primary px-2.5 py-1 rounded-lg font-black">${todayTasks.length}</span>
                                </h3>
                                <div class="space-y-3">
                                    ${todayTasks.length === 0 
                                        ? '<div class="py-16 text-center bg-card rounded-3xl border border-border border-dashed flex flex-col items-center"><span class="text-4xl mb-4">ðŸŽ‰</span><p class="text-text font-bold text-lg mb-1">All clear!</p><p class="text-sm text-muted">Enjoy your free time or plan ahead.</p></div>' 
                                        : todayTasks.map((t, i) => app.templates.taskCard(t, i)).join('')}
                                </div>
                            </div>
                        </div>`;
                },

                calendar: (container) => {
                    const mode = app.state.calendarMode;
                    const date = app.state.currentDate;
                    
                    let headerText = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                    if (mode === 'daily') headerText = date.toLocaleString('default', { weekday: 'long', month: 'short', day: 'numeric' });

                    let contentHtml = '';
                    if (mode === 'monthly') contentHtml = app.views.renderMonth(date);
                    else contentHtml = app.views.renderDay(date);

                    container.innerHTML = `
                        <div class="animate-fade-in h-full flex flex-col max-w-5xl mx-auto">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 md:mb-8">
                                <h2 class="text-2xl md:text-3xl font-extrabold text-text">${headerText}</h2>
                                <div class="flex flex-wrap gap-3 w-full md:w-auto">
                                    <div class="flex bg-card border border-border/50 rounded-2xl p-1 shadow-sm flex-1 md:flex-none">
                                        <button onclick="app.views.changeDate(-1)" class="p-2.5 hover:bg-bg-sec rounded-xl transition-colors active:scale-95"><svg class="w-5 h-5 text-text" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg></button>
                                        <button onclick="app.state.currentDate = new Date(); app.router('calendar')" class="flex-1 text-xs font-black px-4 hover:bg-bg-sec rounded-xl transition-colors text-text uppercase tracking-widest">Today</button>
                                        <button onclick="app.views.changeDate(1)" class="p-2.5 hover:bg-bg-sec rounded-xl transition-colors active:scale-95"><svg class="w-5 h-5 text-text" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/></svg></button>
                                    </div>
                                    <div class="flex p-1 bg-card border border-border/50 rounded-2xl shadow-sm flex-1 md:flex-none">
                                        <button onclick="app.state.calendarMode = 'monthly'; app.router('calendar')" class="flex-1 px-5 py-2 text-xs font-black rounded-xl transition-all uppercase tracking-widest ${mode === 'monthly' ? 'bg-primary text-white shadow-md' : 'text-muted hover:text-text'}">Month</button>
                                        <button onclick="app.state.calendarMode = 'daily'; app.router('calendar')" class="flex-1 px-5 py-2 text-xs font-black rounded-xl transition-all uppercase tracking-widest ${mode === 'daily' ? 'bg-primary text-white shadow-md' : 'text-muted hover:text-text'}">Day</button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto">${contentHtml}</div>
                        </div>
                    `;
                },

                renderMonth: (date) => {
                    const year = date.getFullYear(), month = date.getMonth();
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const todayStr = new Date().toDateString();
                    
                    let html = '<div class="grid grid-cols-7 gap-1.5 md:gap-3 text-center text-[10px] font-black text-muted mb-3 uppercase tracking-widest"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div><div class="grid grid-cols-7 gap-1.5 md:gap-3 auto-rows-fr">';
                    
                    for(let i=0; i<firstDay; i++) html += '<div class="bg-transparent"></div>';
                    
                    for(let i=1; i<=daysInMonth; i++) {
                        const cellDate = new Date(year, month, i);
                        const isToday = cellDate.toDateString() === todayStr;
                        const tasks = app.state.tasks.filter(t => !t.completed && new Date(t.date).toDateString() === cellDate.toDateString());
                        
                        html += `<div onclick="app.state.currentDate = new Date('${year}-${month+1}-${i}'); app.state.calendarMode='daily'; app.router('calendar')" 
                                      class="min-h-[80px] md:min-h-[120px] bg-card border ${isToday ? 'border-primary ring-1 ring-primary' : 'border-border/50'} rounded-2xl p-2 md:p-3 cursor-pointer hover:ring-2 hover:ring-primary/40 hover:border-primary transition-all flex flex-col group relative overflow-hidden shadow-sm active:scale-[0.98]">
                                    <span class="text-xs font-extrabold w-7 h-7 flex items-center justify-center rounded-full ${isToday ? 'bg-primary text-white shadow-lg shadow-primary/40' : 'text-text group-hover:bg-bg-sec'} transition-colors">${i}</span>
                                    <div class="flex-1 flex flex-col gap-1 md:gap-1.5 mt-2 overflow-hidden w-full">
                                        ${tasks.slice(0,3).map(t => `
                                            <div class="h-1.5 md:h-2 w-full rounded-full ${t.priority === 'High' ? 'bg-red-500' : (t.priority === 'Medium' ? 'bg-orange-500' : 'bg-emerald-500')} opacity-90"></div>
                                        `).join('')}
                                        ${tasks.length > 3 ? '<div class="text-[8px] font-bold text-muted text-center mt-auto">+' + (tasks.length - 3) + '</div>' : ''}
                                    </div>
                                 </div>`;
                    }
                    return html + '</div>';
                },

                renderDay: (date) => {
                    const tasks = app.state.tasks.filter(t => new Date(t.date).toDateString() === date.toDateString());
                    tasks.sort((a,b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1); 
                    
                    return `
                        <div class="space-y-3">
                            ${tasks.length ? tasks.map((t, i) => app.templates.taskCard(t, i)).join('') : 
                            '<div class="text-center py-20 flex flex-col items-center"><div class="w-20 h-20 bg-card border border-border shadow-sm rounded-full flex items-center justify-center mb-5 text-muted"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div><p class="text-text font-bold text-lg">No plans for this day.</p><button onclick="app.ui.openTaskModal()" class="mt-6 px-8 py-3.5 bg-primary text-white rounded-2xl font-bold text-sm shadow-lg shadow-primary/30 hover:bg-indigo-600 active:scale-95 transition-all">Add Task</button></div>'}
                        </div>`;
                },

                searchResults: (container) => {
                    const q = app.state.searchQuery.toLowerCase();
                    const results = app.state.tasks.filter(t => t.name.toLowerCase().includes(q) || (t.category && t.category.toLowerCase().includes(q)) || (t.desc && t.desc.toLowerCase().includes(q)));
                    container.innerHTML = `
                        <div class="animate-fade-in space-y-4 max-w-5xl mx-auto">
                             <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl md:text-2xl font-extrabold text-text">Results for "${app.utils.escapeHtml(q)}"</h2>
                                <button onclick="document.getElementById('global-search').value=''; app.utils.debounceSearch('')" class="text-xs px-3 py-1.5 bg-bg-sec rounded-lg text-text font-bold hover:bg-border transition-colors">Clear</button>
                             </div>
                             <div class="space-y-3">
                                ${results.length ? results.map((t, i) => app.templates.taskCard(t, i)).join('') : '<div class="py-12 text-center text-muted font-medium bg-card border border-border rounded-3xl">No matches found.</div>'}
                             </div>
                        </div>
                    `;
                },

                changeDate: (dir) => {
                    const d = app.state.currentDate;
                    if(app.state.calendarMode === 'monthly') d.setMonth(d.getMonth() + dir);
                    else d.setDate(d.getDate() + dir);
                    app.state.currentDate = new Date(d);
                    app.router('calendar');
                },

                focus: (container) => {
                    container.innerHTML = `
                        <div class="animate-fade-in flex flex-col items-center justify-center h-full text-center space-y-8 max-w-lg mx-auto pb-10">
                            <div class="relative group cursor-pointer" onclick="app.focus.openOverlay()">
                                <div class="absolute inset-0 bg-primary/30 blur-2xl rounded-full animate-pulse group-hover:bg-primary/50 transition-colors"></div>
                                <div class="p-10 bg-card border border-border rounded-[3rem] relative shadow-2xl transition-transform transform group-hover:scale-105 active:scale-95 duration-300">
                                    <svg class="w-24 h-24 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                            </div>
                            <div>
                                <h2 class="text-3xl md:text-4xl font-black mb-4 tracking-tight text-text">Deep Focus</h2>
                                <p class="text-muted text-base md:text-lg leading-relaxed max-w-sm mx-auto font-medium">Enter a distraction-free environment to accomplish your most important tasks.</p>
                            </div>
                            <button onclick="app.focus.openOverlay()" class="px-12 py-4.5 bg-primary text-white font-extrabold text-lg rounded-full shadow-xl shadow-primary/40 hover:scale-105 active:scale-95 transition-all flex items-center gap-3">
                                Start Timer
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </button>
                        </div>`;
                }
            },

            templates: {
                taskCard: (task, index = 0) => {
                    const priorityColor = task.priority === 'High' ? 'text-red-600 bg-red-500/15 border-red-500/20' : (task.priority === 'Medium' ? 'text-orange-600 bg-orange-500/15 border-orange-500/20' : 'text-emerald-600 bg-emerald-500/15 border-emerald-500/20');
                    const animationDelay = `style="animation-delay: ${index * 0.05}s"`;

                    return `
                        <div ${animationDelay} class="animate-stagger-up opacity-0 group bg-card p-4 md:p-5 rounded-2xl md:rounded-3xl border border-border/50 shadow-sm flex items-start gap-4 transition-all hover:border-primary/40 hover:shadow-md cursor-pointer active:scale-[0.99]" onclick="app.ui.openTaskModal(${task.id})">
                            <div class="mt-0.5 relative flex-shrink-0" onclick="event.stopPropagation()">
                                <input type="checkbox" class="task-checkbox appearance-none w-6 h-6 md:w-7 md:h-7 rounded-lg border-2 border-muted/30 checked:border-primary checked:bg-primary transition-all cursor-pointer peer" ${task.completed ? 'checked' : ''} onchange="app.tasks.toggle(${task.id})">
                                <svg class="absolute inset-0 w-6 h-6 md:w-7 md:h-7 pointer-events-none text-white opacity-0 peer-checked:opacity-100 transition-opacity p-1 md:p-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                            </div>
                            <div class="flex-1 min-w-0 transition-opacity duration-300 ${task.completed ? 'opacity-50' : ''}">
                                <div class="flex justify-between items-start gap-3">
                                    <h4 class="font-bold text-text text-base md:text-lg truncate ${task.completed ? 'line-through text-muted' : ''}">${app.utils.escapeHtml(task.name)}</h4>
                                    <span class="flex-shrink-0 text-[10px] font-black px-2.5 py-1 rounded-md uppercase tracking-widest border ${priorityColor}">${task.priority}</span>
                                </div>
                                ${task.desc ? `<p class="text-sm text-muted font-medium mt-1 line-clamp-2">${app.utils.escapeHtml(task.desc)}</p>` : ''}
                                <div class="flex flex-wrap items-center gap-3 mt-3.5">
                                    <div class="flex items-center gap-1.5 text-xs font-semibold text-muted bg-bg-sec px-2.5 py-1 rounded-lg">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        ${new Date(task.date).toLocaleDateString('en-US', {month:'short', day:'numeric'})}
                                    </div>
                                    ${task.category ? `<span class="text-xs font-semibold text-text bg-primary/10 px-2.5 py-1 rounded-lg flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full bg-primary"></span>${app.utils.escapeHtml(task.category)}</span>` : ''}
                                    ${task.repeat !== 'none' ? '<div class="bg-bg-sec p-1 rounded-lg"><svg class="w-3.5 h-3.5 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></div>' : ''}
                                </div>
                            </div>
                            ${!task.completed ? `<button class="md:opacity-0 group-hover:opacity-100 p-2.5 text-muted hover:text-primary hover:bg-primary/10 rounded-xl transition-all flex-shrink-0" onclick="event.stopPropagation(); app.focus.startSpecific(${task.id})" title="Focus"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></button>` : ''}
                        </div>`;
                }
            },

            tasks: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('task-id').value;
                    const data = {
                        name: document.getElementById('task-name').value,
                        desc: document.getElementById('task-desc').value,
                        date: document.getElementById('task-date').value,
                        priority: document.getElementById('task-priority').value,
                        category: document.getElementById('task-category').value,
                        repeat: document.getElementById('task-repeat').value,
                    };

                    if (id) {
                        const index = app.state.tasks.findIndex(t => t.id == id);
                        app.state.tasks[index] = { ...app.state.tasks[index], ...data };
                        app.ui.showToast('Task updated successfully');
                    } else {
                        app.state.tasks.push({ id: Date.now(), completed: false, completedDate: null, ...data });
                        app.ui.showToast('New task created');
                    }
                    app.persist();
                    app.ui.closeModals();
                    app.router(app.state.view);
                },
                toggle: (id) => {
                    const task = app.state.tasks.find(t => t.id === id);
                    if (task) {
                        task.completed = !task.completed;
                        task.completedDate = task.completed ? new Date().toISOString().split('T')[0] : null;
                        
                        if(task.completed) {
                            app.gamification.addXP(20);
                            app.ui.showToast('Task completed! +20 XP');
                        }
                        app.persist();
                        // Delay router update slightly to let checkbox animation play
                        setTimeout(() => app.router(app.state.view), 300);
                    }
                },
                delete: () => {
                    if(!confirm("Are you sure you want to delete this task?")) return;
                    const id = document.getElementById('task-id').value;
                    app.state.tasks = app.state.tasks.filter(t => t.id != id);
                    app.persist();
                    app.ui.closeModals();
                    app.ui.showToast('Task deleted');
                    app.router(app.state.view);
                },
                checkRecurring: () => {
                    const today = new Date();
                    let updated = false;
                    app.state.tasks.forEach(t => {
                        if (t.repeat !== 'none' && t.completed && new Date(t.date) < today) {
                            const d = new Date(t.date);
                            if (t.repeat === 'daily') d.setDate(d.getDate() + 1);
                            if (t.repeat === 'weekly') d.setDate(d.getDate() + 7);
                            if (t.repeat === 'monthly') d.setMonth(d.getMonth() + 1);
                            
                            app.state.tasks.push({
                                ...t, id: Date.now() + Math.random(),
                                date: d.toISOString().split('T')[0],
                                completed: false, completedDate: null
                            });
                            
                            t.repeat = 'none'; 
                            updated = true;
                        }
                    });
                    if(updated) app.persist();
                }
            },

            gamification: {
                checkStreak: () => {
                    const today = new Date().toDateString();
                    if (app.state.profile.lastLogin !== today) {
                        const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                        if (app.state.profile.lastLogin === yesterday.toDateString()) {
                            app.state.profile.streak++;
                        } else if(app.state.profile.lastLogin !== today && app.state.profile.lastLogin !== null) {
                            app.state.profile.streak = 1; 
                        } else if(app.state.profile.lastLogin === null) {
                            app.state.profile.streak = 1;
                        }
                        app.state.profile.lastLogin = today;
                        app.persist();
                    }
                },
                addXP: (amount) => {
                    app.state.profile.xp += amount;
                    const next = app.state.profile.level * 100;
                    if(app.state.profile.xp >= next) {
                        app.state.profile.level++;
                        app.state.profile.xp = app.state.profile.xp - next;
                        app.ui.showToast(`ðŸŽ‰ Level Up! You are now Level ${app.state.profile.level}`);
                        document.body.classList.add('animate-bounce-slight');
                        setTimeout(() => document.body.classList.remove('animate-bounce-slight'), 400);
                    }
                    app.ui.renderProfile();
                }
            },

            focus: {
                openOverlay: () => {
                    document.getElementById('focus-overlay').classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                    app.focus.reset();
                },
                startSpecific: (id) => {
                    const task = app.state.tasks.find(t => t.id === id);
                    app.focus.openOverlay();
                    document.getElementById('focus-task-display').innerText = task.name;
                    app.state.timer.activeTask = id;
                },
                toggle: () => {
                    const btn = document.getElementById('focus-toggle');
                    if(app.state.timer.isRunning) {
                        clearInterval(app.state.timer.interval);
                        app.state.timer.isRunning = false;
                        btn.innerText = "Resume Timer";
                        btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                        btn.classList.add('bg-primary', 'hover:bg-indigo-600');
                    } else {
                        app.state.timer.isRunning = true;
                        btn.innerText = "Pause Timer";
                        btn.classList.remove('bg-primary', 'hover:bg-indigo-600');
                        btn.classList.add('bg-red-500', 'hover:bg-red-600');
                        
                        app.state.timer.interval = setInterval(() => {
                            app.state.timer.timeLeft--;
                            app.focus.updateDisplay();
                            
                            if(app.state.timer.timeLeft <= 0) app.focus.complete();
                        }, 1000);
                    }
                },
                updateDisplay: () => {
                     const m = Math.floor(app.state.timer.timeLeft / 60);
                     const s = app.state.timer.timeLeft % 60;
                     document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                     
                     const circle = document.getElementById('timer-circle');
                     const pct = (1500 - app.state.timer.timeLeft) / 1500;
                     // Circumference is approx 729 for r=116
                     const offset = 729 - (729 * pct);
                     circle.style.strokeDashoffset = offset; 
                },
                complete: () => {
                    clearInterval(app.state.timer.interval);
                    app.state.timer.isRunning = false;
                    document.getElementById('timer-display').innerText = "Done!";
                    app.gamification.addXP(50);
                    app.ui.showToast('Focus session complete! +50 XP');
                    
                    if(app.state.timer.activeTask) {
                        if(confirm("Great job! Mark task as completed?")) {
                             app.tasks.toggle(app.state.timer.activeTask);
                             app.focus.exit();
                        }
                    }
                },
                reset: () => {
                    clearInterval(app.state.timer.interval);
                    app.state.timer = { interval: null, timeLeft: 1500, isRunning: false, activeTask: null };
                    document.getElementById('timer-display').innerText = "25:00";
                    document.getElementById('focus-toggle').innerText = "Start Timer";
                    document.getElementById('timer-circle').style.strokeDashoffset = 729;
                    document.getElementById('focus-toggle').classList.add('bg-primary', 'hover:bg-indigo-600');
                    document.getElementById('focus-toggle').classList.remove('bg-red-500', 'hover:bg-red-600');
                    document.getElementById('focus-task-display').innerText = "Deep Work";
                },
                exit: () => {
                    if(app.state.timer.isRunning && !confirm("Stop timer and exit?")) return;
                    app.focus.reset();
                    document.getElementById('focus-overlay').classList.add('hidden');
                    document.body.style.overflow = '';
                    app.router(app.state.view);
                }
            },

            data: {
                backup: () => {
                    const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ tasks: app.state.tasks, profile: app.state.profile, theme: app.state.theme }));
                    const a = document.createElement('a');
                    a.href = data; a.download = `proplanner_v2_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                },
                restore: (input) => {
                    if(!input.files[0]) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const d = JSON.parse(e.target.result);
                            app.state.tasks = d.tasks || [];
                            app.state.profile = d.profile || app.state.profile;
                            app.state.theme = d.theme || 'light';
                            app.persist(); 
                            app.ui.showToast("Data imported successfully!");
                            setTimeout(() => location.reload(), 1000);
                        } catch(err) { alert("Invalid backup file"); }
                    };
                    reader.readAsText(input.files[0]);
                },
                clear: () => {
                    if(confirm("This will permanently delete ALL tasks and settings. Continue?")) {
                        localStorage.removeItem('proplanner_db_v2');
                        location.reload();
                    }
                }
            },

            ui: {
                showToast: (msg) => {
                    const el = document.createElement('div');
                    el.className = 'toast';
                    el.innerHTML = `<div class="bg-primary/20 p-1.5 rounded-full"><svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg></div> ${msg}`;
                    document.getElementById('toast-container').appendChild(el);
                    setTimeout(() => {
                        el.style.opacity = '0';
                        el.style.transform = 'translateY(-20px)';
                        el.style.transition = 'all 0.3s ease';
                        setTimeout(() => el.remove(), 300);
                    }, 3500);
                },
                setTheme: (t) => {
                    app.state.theme = t;
                    document.documentElement.className = t;
                    app.persist();
                    
                    // Update Settings UI
                    ['light', 'dark', 'midnight'].forEach(theme => {
                        const btn = document.getElementById(`theme-btn-${theme}`);
                        if(btn) {
                            if(theme === t) btn.classList.add('ring-2', 'ring-primary', 'border-primary');
                            else btn.classList.remove('ring-2', 'ring-primary', 'border-primary');
                        }
                    });
                },
                openTaskModal: (taskId = null) => {
                    document.getElementById('task-form').reset();
                    if (taskId) {
                        const t = app.state.tasks.find(x => x.id === taskId);
                        document.getElementById('task-id').value = t.id;
                        document.getElementById('task-name').value = t.name;
                        document.getElementById('task-desc').value = t.desc || '';
                        document.getElementById('task-date').value = t.date;
                        document.getElementById('task-priority').value = t.priority;
                        document.getElementById('task-category').value = t.category || '';
                        document.getElementById('task-repeat').value = t.repeat;
                        document.getElementById('modal-title').innerText = "Edit Task";
                        document.getElementById('btn-delete').classList.remove('hidden');
                    } else {
                        document.getElementById('task-id').value = '';
                        document.getElementById('modal-title').innerText = "New Task";
                        document.getElementById('task-date').value = new Date().toISOString().split('T')[0];
                        document.getElementById('btn-delete').classList.add('hidden');
                    }
                    document.getElementById('task-modal').classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevent body scroll on mobile
                },
                toggleSettings: () => {
                    const modal = document.getElementById('settings-modal');
                    if(modal.classList.contains('hidden')) {
                        modal.classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                    } else {
                        app.ui.closeModals();
                    }
                },
                closeModals: () => {
                    document.getElementById('task-modal').classList.add('hidden');
                    document.getElementById('settings-modal').classList.add('hidden');
                    document.body.style.overflow = '';
                },
                renderProfile: () => {
                    document.getElementById('user-level').innerText = app.state.profile.level;
                    document.getElementById('user-xp').innerText = app.state.profile.xp;
                    const next = app.state.profile.level * 100;
                    document.getElementById('xp-bar').style.width = `${(app.state.profile.xp / next) * 100}%`;
                }
            },
            
            utils: {
                debounceSearch: (val) => {
                    app.state.searchQuery = val;
                    app.router(app.state.view);
                },
                escapeHtml: (unsafe) => {
                    if(!unsafe) return '';
                    return unsafe
                         .replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
                }
            }
        };

        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>